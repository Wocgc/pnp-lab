name: Terraform CI with PR Comment

on:  # Ìä∏Î¶¨Í±∞ Ï°∞Í±¥
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs: # GitHub ActionsÍ∞Ä Ïã§ÌñâÎê† ÌôòÍ≤Ω
  terraform:
    name: Terraform Plan + PR Comment
    runs-on: ubuntu-latest


    permissions:
      pull-requests: write  # PRÏóê ÏΩîÎ©òÌä∏ Îã¨Í∏∞ ÏúÑÌï¥ ÌïÑÏöî

    steps: # Ïã§Ï†ú Ïã§Ìñâ Îã®Í≥ÑÎì§
      - name: Checkout repository
        uses: actions/checkout@v4 # checkout - GitHub ÏΩîÎìú ÎÇ¥Î†§Î∞õÍ∏∞
        # GitHub ActionsÍ∞Ä Ïù¥ Î†àÌè¨Ïùò ÏΩîÎìúÎ•º Í∞ÄÏÉÅÎ®∏Ïã†Ïóê Îã§Ïö¥Î•¥ÎèÑÌï¥ÏÑú ÏÇ¨Ïö©Ìï† Ïàò ÏûàÍ≤å Ìï®(git clone Í∞ôÏùÄ Ïó≠Ìï†)

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform Format
        run: terraform fmt -check -recursive # recursive - ÌïòÏúÑ dirÍπåÏßÄ Ï†ÑÎ∂Ä Í≤ÄÏÇ¨


      - name: Terraform Init
        run: terraform init -backend=false # -backend=false -> s3Í∞ôÏùÄ Î¶¨Î™®Ìä∏ Î∞±ÏóîÎìú Ïó∞Í≤∞ ÏÉùÎûµÌïòÍ≥† Î°úÏª¨Îßå ÏÇ¨Ïö©(CIÏóêÏÑúÎäî Î≥¥ÌÜµ Ïù¥Î†áÍ≤å Ìï®)


      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        id: plan # plan stepÏùò Ï∂úÎ†•ÏùÑ Îã§Ïùå stepÏóêÏÑú Ï∞∏Ï°∞ÌïòÍ∏∞ ÏúÑÌï¥ ID ÏÑ§Ï†ï
        run: | 
          terraform plan -no-color > plan.txt# -no-color CI Î°úÍ∑∏Í∞Ä Ïª¨Îü¨ ÏóÜÏù¥ Ï∂úÎ†• ÎêòÎèÑÎ°ùÌï®(Ïª¨Îü¨ ÎïåÎ¨∏Ïóê Î°úÍ∑∏ Íπ®ÏßÄÎäîÍ±∞ Î∞©ÏßÄ)
          echo '```' >> plan.txt
          cat plan.txt
          echo '```' >> plan.txt

      - name: Comment PR with Plan Result
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('plan.txt', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üõ†Ô∏è Terraform Plan Result:\n\n${planOutput}`
            });
